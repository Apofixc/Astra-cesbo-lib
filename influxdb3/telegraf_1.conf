# Configuration for Telegraf (Optimized for Monitoring Adapters, Channels, and System Metrics)
#
# Optimized notes:
# - Reduces redundancy in JSON parsing by explicitly listing only unique tags/fields/objects per input.
# - Adds hysteresis to channel monitor status to filter noise (only alerts on sustained changes >30s).
# - Outputs only changed metrics to Telegram to reduce spam, while sending all to InfluxDB for storage.
# - Use environment variables for all secrets/sensitive values.
# - Adjust global_tags, intervals, or decimation based on your load.

[global_tags]
#  env = "production"  # Example global tag; add others if needed (e.g., region, team)

[agent]
  interval = "10s"
  round_interval = true
  metric_batch_size = 1000  # Increased from 1000 for better batching
  metric_buffer_limit = 10000
  collection_jitter = "1s"
  flush_interval = "10s"
  flush_jitter = "0s"
  precision = "1s"
  snmp_translator = "gosmi"
  debug = true  # Enable during testing, remove in production

###############################################################################
# SERVICE INPUT PLUGINS (HTTP Listeners for Adapter/Channel Monitoring)      #
###############################################################################

# Input for adapter status monitoring
[[inputs.http_listener_v2]]
  name_override = "adapter_monitor"
  service_address = ":8080"
  paths = ["/adapters"]
  methods = ["POST"]
  data_source = "body"
  data_format = "json_v2"

  [[inputs.http_listener_v2.json_v2]]
    measurement_name = "adapter_status"

    # Tags for identification
    [[inputs.http_listener_v2.json_v2.tag]]
      path = "type"
    [[inputs.http_listener_v2.json_v2.tag]]
      path = "server"
    [[inputs.http_listener_v2.json_v2.tag]]
      path = "format"
    [[inputs.http_listener_v2.json_v2.tag]]
      path = "modulation"
    [[inputs.http_listener_v2.json_v2.tag]]
      path = "source"
    [[inputs.http_listener_v2.json_v2.tag]]
      path = "adapter_name"
    [[inputs.http_listener_v2.json_v2.tag]]
      path = "name_source"

    # Fields for metrics
    [[inputs.http_listener_v2.json_v2.field]]
      path = "status"
    [[inputs.http_listener_v2.json_v2.field]]
      path = "signal"
    [[inputs.http_listener_v2.json_v2.field]]
      path = "snr"
    [[inputs.http_listener_v2.json_v2.field]]
      path = "ber"
    [[inputs.http_listener_v2.json_v2.field]]
      path = "unc"

# Input for channel status monitoring
[[inputs.http_listener_v2]]
  name_override = "channel_monitor"
  service_address = ":8081"
  paths = ["/channels"]
  methods = ["POST"]
  data_source = "body"
  data_format = "json_v2"

  [[inputs.http_listener_v2.json_v2]]
    measurement_name = "channel_monitor"

    # Shared tags (optimized for readability)
    [[inputs.http_listener_v2.json_v2.tag]]
      path = "type"
    [[inputs.http_listener_v2.json_v2.tag]]
      path = "server"
    [[inputs.http_listener_v2.json_v2.tag]]
      path = "channel"
    [[inputs.http_listener_v2.json_v2.tag]]
      path = "monitor"
    [[inputs.http_listener_v2.json_v2.tag]]
      path = "format"
    [[inputs.http_listener_v2.json_v2.tag]]
      path = "addr"

    # Fields
    [[inputs.http_listener_v2.json_v2.field]]
      path = "ready"
    [[inputs.http_listener_v2.json_v2.field]]
      path = "scrambled"
    [[inputs.http_listener_v2.json_v2.field]]
      path = "bitrate"
    [[inputs.http_listener_v2.json_v2.field]]
      path = "cc_error"
    [[inputs.http_listener_v2.json_v2.field]]
      path = "pes_error"

# Input for channel pid errors
[[inputs.http_listener_v2]]
  name_override = "channel_analyze"
  service_address = ":8082"
  paths = ["/analyze"]
  methods = ["POST"]
  data_source = "body"
  data_format = "json_v2"

  [[inputs.http_listener_v2.json_v2]]
    measurement_name = "channel_analyze"

    # Same shared tags as above
    [[inputs.http_listener_v2.json_v2.tag]]
      path = "type"
    [[inputs.http_listener_v2.json_v2.tag]]
      path = "server"
    [[inputs.http_listener_v2.json_v2.tag]]
      path = "channel"
    [[inputs.http_listener_v2.json_v2.tag]]
      path = "monitor"
    [[inputs.http_listener_v2.json_v2.tag]]
      path = "format"
    [[inputs.http_listener_v2.json_v2.tag]]
      path = "addr"

    [[inputs.http_listener_v2.json_v2.object]]
      path = "analyze"
      tags = ["pid"]
      included_keys = ["bitrate", "pid", "cc_error", "pes_error", "sc_error"]

# Input for channel error logs
[[inputs.http_listener_v2]]
  name_override = "channel_error"
  service_address = ":8083"
  paths = ["/errors"]
  methods = ["POST"]
  data_source = "body"
  data_format = "json_v2"

  [[inputs.http_listener_v2.json_v2]]
    measurement_name = "channel_error"

    # Same shared tags
    [[inputs.http_listener_v2.json_v2.tag]]
      path = "type"
    [[inputs.http_listener_v2.json_v2.tag]]
      path = "server"
    [[inputs.http_listener_v2.json_v2.tag]]
      path = "channel"
    [[inputs.http_listener_v2.json_v2.tag]]
      path = "monitor"
    [[inputs.http_listener_v2.json_v2.tag]]
      path = "format"
    [[inputs.http_listener_v2.json_v2.tag]]
      path = "addr"

    [[inputs.http_listener_v2.json_v2.field]]
      path = "error"

###############################################################################
# SYSTEM INPUT PLUGINS (Basic Node Monitoring)                                #
###############################################################################

[[inputs.cpu]]
  percpu = true
  totalcpu = true
  collect_cpu_time = false
  report_active = true
  interval = "30s"  # Increased for reduced CPU load

[[inputs.mem]]
  interval = "30s"  # Balanced for mem stats

[[inputs.disk]]
  interval = "60s"  # Less frequent for disk checks
  # mount_points = ["/"]  # Uncomment to limit

[[inputs.nstat]]
  interval = "30s"  # Balanced for network stats

###############################################################################
# PROCESSORS (Data Transformation and Filtering)                              #
###############################################################################

# Adds change detection to channel_monitor metrics (for diffing ready status)
[[processors.change]]
  namepass = ["channel_monitor"]
  fields = ["ready"]
  # This adds "ready_previous" field and (optionally) "ready_change" for transitions

# Duplicates channel_monitor metrics: one for Telegram (filtered), one for InfluxDB (all)
[[processors.duplicate]]
  namepass = ["channel_monitor"]
  suffix = "_notif"

# Hysteresis filter (debounce short changes >30s) using Starlark state
[[processors.starlark]]
  namepass = ["channel_monitor_notif"]
  script = '''
state = {}

def apply(metric):
    key = metric.tags.get("server", "") + "_" + metric.tags.get("channel", "")
    ready = metric.fields.get("ready", 0)
    ready_change = metric.fields.get("ready_change", 0)
    
    if ready_change == 0:
        return None  # Skip if no change
    
    if key not in state:
        state[key] = {"time": 0, "prev_ready": ready}
    
    current_time = metric.time  # Assuming metric has time; use wall clock if needed
    if state[key]["prev_ready"] != ready:
        state[key]["time"] = current_time
        state[key]["prev_ready"] = ready
        return None  # Start debounce timer
    
    if current_time - state[key]["time"] > 30:  # 30s debounce
        metric.tags["ready_stable"] = "stable"
        return metric
    return None
'''

# Filters for stable changes only (after debounce)
[[processors.filter]]
  namepass = ["channel_monitor_notif"]
  where = '("ready_stable" == "stable") and not empty <- ("ready_stable")'

###############################################################################
# OUTPUT PLUGINS (Notifications and Storage)                                  #
###############################################################################

# Telegram notifications only for changed channel_monitor metrics (after debouncing)
[[outputs.telegram]]
  bot_token = "${TELEGRAM_BOT_TOKEN}"
  send_message_for_each_metric = true
  message_template = """
ðŸŒ Channel <b>{{.Tag "channel"}}</b> status:
  Prev: {{.Field "ready_previous" | printf "%.0f"}}, Now: <b>{{.Field "ready" | printf "%.0f"}}</b>
  ({{.Tag "type"}} | {{.Tag "server"}} | {{.Tag "ready_stable"}})
  """
  parse_mode = "HTML"
  namepass = ["channel_monitor_notif", "channel_error"]
  chat_id = "${TELEGRAM_CHAT_ID}" 

[[outputs.influxdb_v2]]
  urls = ["http://localhost:8181"]
  token = "apiv3_mzB7V1ifPDa2JkF-0ew_NXbnjdbVMoVjAJFJL4Lj5TkplrfWhB7BXG2QqCnP4Yy7WJ4Ia7h4i1OPykL6Eb3Itw"
  organization = ""
  bucket = "astra"
  content_encoding = "gzip"
  namepass = ["adapter_monitor", "channel_monitor", "channel_analyze"]